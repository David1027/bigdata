(function(){var a={config:{host:"",url:"/api/analytics",key:"shoestp",project:"bigdata",timeout:15,issend:true},init:function(){var d=this;if(sessionStorage&&!sessionStorage[d.config.key+d.config.project]){if(document.referrer){document.referrer=""}sessionStorage[d.config.key+d.config.project]=document.referrer;d.cookie.set("_"+d.config.key+"_first_referrer",document.referrer,"s900")}if(localStorage&&localStorage[d.config.key+"userKey"]){this.data.userInfo=localStorage[d.config.key+"userKey"]}var b=null;if(document.onmousedown){b=document.onmousedown}document.onmousedown=function(f){var e=f||event;if(d.data.mouseClick.length>20){d.data.mouseClick.splice(0,1)}d.data.mouseClick.push({x:e.clientX,y:e.clientY,scroll:d.ScollPostion(),date:new Date()});if(b){b(f)}};if(window.sysConfig&&window.sysConfig.user){d.data.userInfo={id:sysConfig.user.id,userName:sysConfig.user.name,email:sysConfig.user.name}}if(d.cookie.get("__"+d.config.key+"_UUID")){d.data.userInfo={userName:d.cookie.get("__"+d.config.key+"_UUID")};d.data.session=d.cookie.get("__"+d.config.key+"_session");d.data.session_create_time=d.cookie.get("__"+d.config.key+"_UUID_create_time")}if(!d.data.userInfo||d.data.userInfo.userName){console.log("请求签名");this.ajax.get(this.config.host+"/api/analytics/device_sign",function(f){f=JSON.parse(f);d.cookie.set("__"+d.config.key+"_session",f.result.session);var e=Number(new Date());d.cookie.set("__"+d.config.key+"_session_time",e);d.cookie.set("__"+d.config.key+"_UUID",f.result.sign,"d360");d.data.userInfo={userName:f.result.sign};d.data.session=f.result.session;d.data.session_create_time=e})}window.addEventListener("unload",function(e){d.data.firstReferrer=sessionStorage[d.config.key+d.config.project];if(d.config.issend){navigator.sendBeacon(d.config.host+d.config.url,JSON.stringify(d.data))}});var c=setTimeout(function(){d.data.firstReferrer=sessionStorage[d.config.key+d.config.project];d.ajax.post(d.config.host+d.config.url,JSON.stringify(d.data));d.cookie.set("__"+d.config.key+"_session",null,-1);d.cookie.set("__"+d.config.key+"_session_time",null,-1);clearTimeout(c);d.config.issend=false},d.config.timeout*60*1000)},data:{title:document.title,url:window.location.href,uri:window.location.pathname,firstReferrer:sessionStorage.bigdata,pageReferrer:document.referrer,pageLoadInfo:window.performance.timing,mouseClick:[],windows:{height:window.screen.height,width:window.screen.width},userInfo:null,session:null,session_create_time:null},ScollPostion:function(){var d,c,b,e;if(document.documentElement&&document.documentElement.scrollTop){d=document.documentElement.scrollTop;c=document.documentElement.scrollLeft;b=document.documentElement.scrollWidth;e=document.documentElement.scrollHeight}else{if(document.body){d=document.body.scrollTop;c=document.body.scrollLeft;b=document.body.scrollWidth;e=document.body.scrollHeight}}return{top:d,left:c,width:b,height:e}},ajax:{get:function(b,c){var d=new XMLHttpRequest();d.open("GET",b,true);d.onreadystatechange=function(){if(d.readyState==4&&d.status==200||d.status==304){c.call(this,d.responseText)}};d.send()},post:function(c,e,d,b){if(!b){b="application/x-www-form-urlencoded"}var f=new XMLHttpRequest();f.open("POST",c,true);f.setRequestHeader("Content-Type",b);f.onreadystatechange=function(){if(f.readyState==4&&(f.status==200||f.status==304)){d.call(this,f.responseText)}};f.send(e)}},cookie:{get:function(c){var b,d=new RegExp("(^| )"+c+"=([^;]*)(;|$)");if(b=document.cookie.match(d)){return unescape(b[2])}else{return null}},set:function(b,e,h,g){function f(l){if(!l){return null}var k=l.substring(1,l.length)*1;var j=l.substring(0,1);if(j=="s"){return k*1000}else{if(j=="h"){return k*60*60*1000}else{if(j=="d"){return k*24*60*60*1000}}}}var c=f(h);var d="";if(c){var i=new Date();i.setTime(i.getTime()+c*1);d=";expires="+i.toUTCString()}if(!g){g=";path=/"}else{g=";path="+g}console.log(b+"="+escape(e)+g+d);document.cookie=b+"="+escape(e)+g+d}}};a.init()})(window);